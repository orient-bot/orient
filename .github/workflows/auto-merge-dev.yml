# =============================================================================
# Auto-merge PRs to dev branch for tombensim
# =============================================================================
# Automatically merges PRs from tombensim to dev branch after CI passes.
#
# Requirements:
# - Add a PAT with repo scope as a repository secret named AUTO_MERGE_PAT
# - The PAT must belong to a user who can bypass branch protection (tombensim)
#
# This workflow triggers after the test workflow completes, then checks if
# the PR qualifies for auto-merge.
# =============================================================================

name: Auto-merge to dev

on:
  workflow_run:
    workflows: ['Tests']
    types: [completed]

jobs:
  auto-merge:
    name: Auto-merge PR
    runs-on: ubuntu-latest
    # Only run if the test workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Find and merge eligible PR
        uses: actions/github-script@v7
        env:
          AUTO_MERGE_PAT: ${{ secrets.AUTO_MERGE_PAT }}
        with:
          github-token: ${{ secrets.AUTO_MERGE_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const headSha = context.payload.workflow_run.head_sha;
            const headBranch = context.payload.workflow_run.head_branch;

            console.log(`Test workflow completed for branch: ${headBranch}`);
            console.log(`Head SHA: ${headSha}`);

            // Find open PRs with this head SHA
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            // Filter to find the PR matching this commit
            const pr = prs.find(p => p.head.sha === headSha);

            if (!pr) {
              console.log('No open PR found for this commit');
              return;
            }

            console.log(`Found PR #${pr.number}: ${pr.title}`);
            console.log(`  Author: ${pr.user.login}`);
            console.log(`  Base: ${pr.base.ref}`);

            // Check if PR qualifies for auto-merge
            const allowedAuthors = ['tombensim'];
            if (!allowedAuthors.includes(pr.user.login)) {
              console.log(`Author ${pr.user.login} not in allowed list, skipping`);
              return;
            }

            if (pr.base.ref !== 'dev') {
              console.log(`Base branch ${pr.base.ref} is not dev, skipping`);
              return;
            }

            console.log('PR qualifies for auto-merge, attempting merge...');

            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'merge'
              });

              console.log(`Successfully merged PR #${pr.number}`);
            } catch (error) {
              console.log(`Could not merge: ${error.message}`);
              // This is expected if branch protection requires reviews
              // The user will need to set up AUTO_MERGE_PAT secret
            }
