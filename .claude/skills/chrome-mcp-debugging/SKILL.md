---
name: chrome-mcp-debugging
description: Debug Chrome MCP socket communication, inspect protocols, and bridge native host tools over HTTP. Use when troubleshooting Chrome extension MCP connections, analyzing message formats, or exposing browser automation tools to external clients like Docker containers.
---

# Chrome MCP Debugging

Comprehensive guide for debugging Chrome MCP socket communication, protocol discovery, and bridging native host tools over HTTP/WebSocket.

## Architecture Overview

The Claude in Chrome extension uses a multi-layer architecture:

```
┌─────────────────────────────────────────────────────────────────────┐
│  Chrome Browser                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  Claude in Chrome Extension                                      ││
│  │  (chrome-extension://fcoeoabgfenejglbffodgkkbkcdhcgfn/)        ││
│  └──────────────────────────┬──────────────────────────────────────┘│
│                             │ Native Messaging (stdio)              │
│                             │ 4-byte length prefix + JSON           │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  chrome-native-host                                              ││
│  │  (~/.claude/chrome/chrome-native-host)                          ││
│  │  Wrapper script that calls: claude --chrome-native-host         ││
│  └──────────────────────────┬──────────────────────────────────────┘│
│                             │ Creates Unix Socket                   │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  Unix Socket: /tmp/claude-mcp-browser-bridge-$USER/<pid>.sock   ││
│  │  Protocol: 4-byte LE length prefix + JSON                       ││
│  └──────────────────────────┬──────────────────────────────────────┘│
│                             │                                       │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  Claude Code CLI                                                 ││
│  │  Connects to socket, uses MCP tools: mcp__claude-in-chrome__*   ││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────┘
```

## Key File Locations

### Native Messaging Host Manifest

```bash
# Chrome native messaging host configuration
cat ~/Library/Application\ Support/Google/Chrome/NativeMessagingHosts/com.anthropic.claude_code_browser_extension.json
```

```json
{
  "name": "com.anthropic.claude_code_browser_extension",
  "description": "Claude Code Browser Extension Native Host",
  "path": "/Users/$USER/.claude/chrome/chrome-native-host",
  "type": "stdio",
  "allowed_origins": ["chrome-extension://fcoeoabgfenejglbffodgkkbkcdhcgfn/"]
}
```

### Native Host Wrapper Script

```bash
cat ~/.claude/chrome/chrome-native-host
```

```bash
#!/bin/sh
# Chrome native host wrapper script
# Generated by Claude Code - do not edit manually
exec "/Users/$USER/.local/share/claude/versions/X.X.X" --chrome-native-host
```

### Unix Socket Location

```bash
# Socket directory (created by chrome-native-host)
ls -la /tmp/claude-mcp-browser-bridge-$USER/

# Example output:
# drwx------   3 user  wheel    96 Jan 26 04:25 .
# srw-------   1 user  wheel     0 Jan 26 04:25 23850.sock
```

### Log Files

```bash
# Chrome native host logs
cat ~/Library/Logs/Claude/chrome-native-host.log

# MCP logs per project (in Claude cache)
ls ~/Library/Caches/claude-cli-nodejs/*/mcp-logs-claude-in-chrome/
```

## Protocol Details

### Binary Message Format

The Chrome MCP socket uses a **4-byte length-prefixed binary protocol** (same as Chrome native messaging):

```
┌────────────┬─────────────────────────────────┐
│  4 bytes   │  N bytes                        │
│  (uint32)  │  (JSON payload)                 │
│  Length N  │  UTF-8 encoded                  │
│  LE order  │                                 │
└────────────┴─────────────────────────────────┘
```

### Reading Messages (TypeScript)

```typescript
function readNativeMessage(buffer: Buffer): { message: unknown; remaining: Buffer } | null {
  if (buffer.length < 4) return null;

  const length = buffer.readUInt32LE(0);
  if (buffer.length < 4 + length) return null;

  const jsonData = buffer.slice(4, 4 + length).toString('utf8');
  const message = JSON.parse(jsonData);
  const remaining = buffer.slice(4 + length);

  return { message, remaining };
}
```

### Writing Messages (TypeScript)

```typescript
function writeNativeMessage(message: unknown): Buffer {
  const json = JSON.stringify(message);
  const jsonBuffer = Buffer.from(json, 'utf8');
  const lengthBuffer = Buffer.alloc(4);
  lengthBuffer.writeUInt32LE(jsonBuffer.length, 0);
  return Buffer.concat([lengthBuffer, jsonBuffer]);
}
```

## Protocol Discovery Findings

### What We Discovered

The Chrome native host socket does **NOT** use standard MCP JSON-RPC protocol. Testing revealed:

1. **Responses lack request IDs**:

   ```json
   // Sent:
   {"jsonrpc":"2.0","id":1,"method":"initialize","params":{...}}

   // Received (no id field!):
   {"result":{"content":"Unknown method: initialize"}}
   ```

2. **Standard MCP methods are not recognized**:
   - `initialize` → "Unknown method: initialize"
   - `tools/call` → "Unknown method: tools/call"
   - `tabs_context_mcp` → "Unknown method: tabs_context_mcp"

3. **The socket is for MCP clients, but uses a custom protocol**

### What This Means

The `claude --chrome-native-host` command:

- Receives messages from Chrome extension via native messaging
- Creates a Unix socket for Claude Code CLI to connect
- Acts as a bridge/proxy between Chrome and Claude Code
- Uses a **proprietary internal protocol**, not standard MCP

## Debugging Commands

### Check if Chrome MCP Socket Exists

```bash
# List socket files
ls -la /tmp/claude-mcp-browser-bridge-$USER/

# If empty or missing, Chrome extension isn't active
```

### Monitor Native Host Logs

```bash
# Real-time log monitoring
tail -f ~/Library/Logs/Claude/chrome-native-host.log
```

### Check Socket Connectivity

```bash
# Test if socket accepts connections (using netcat)
nc -U /tmp/claude-mcp-browser-bridge-$USER/*.sock

# Or with socat for interactive testing
socat - UNIX-CONNECT:/tmp/claude-mcp-browser-bridge-$USER/*.sock
```

### Send Test Message to Socket

```bash
# Create a test message with length prefix
python3 << 'EOF'
import socket
import struct
import json

socket_path = "/tmp/claude-mcp-browser-bridge-$USER/23850.sock"  # Update PID
sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
sock.connect(socket_path)

# Send length-prefixed message
msg = {"jsonrpc": "2.0", "id": 1, "method": "initialize", "params": {}}
json_bytes = json.dumps(msg).encode('utf-8')
sock.send(struct.pack('<I', len(json_bytes)) + json_bytes)

# Read response
length_bytes = sock.recv(4)
if length_bytes:
    length = struct.unpack('<I', length_bytes)[0]
    response = sock.recv(length).decode('utf-8')
    print(f"Response: {response}")

sock.close()
EOF
```

### Inspect Running Processes

```bash
# Find chrome-native-host process
ps aux | grep chrome-native-host

# Find process using the socket
lsof /tmp/claude-mcp-browser-bridge-$USER/*.sock
```

## HTTP Bridge Implementation

### Bridge Architecture

To expose Chrome MCP tools over HTTP for Docker containers:

```
┌─────────────────────────────────────────────────────────────────────┐
│  Docker Container                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  Claude Code                                                     ││
│  │  MCP Config: {"url": "http://host.docker.internal:9877/mcp"}   ││
│  └──────────────────────────┬──────────────────────────────────────┘│
└─────────────────────────────┼───────────────────────────────────────┘
                              │ HTTP (Streamable HTTP Transport)
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Host Machine                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  Chrome MCP HTTP Bridge (scripts/chrome-mcp-http-bridge.ts)     ││
│  │  - Listens on HTTP port 9877                                    ││
│  │  - Converts HTTP ↔ Unix Socket                                  ││
│  │  - Handles binary protocol translation                          ││
│  └──────────────────────────┬──────────────────────────────────────┘│
│                             │ Unix Socket (4-byte length prefix)    │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  Chrome MCP Socket                                               ││
│  │  /tmp/claude-mcp-browser-bridge-$USER/<pid>.sock                ││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────┘
```

### Starting the Bridge

```bash
# Start the HTTP bridge
./scripts/start-chrome-mcp-bridge.sh

# Or with custom port
CHROME_MCP_BRIDGE_PORT=9999 ./scripts/start-chrome-mcp-bridge.sh
```

### Bridge Health Check

```bash
# Check bridge status
curl http://127.0.0.1:9877/health

# Expected response:
{
  "status": "ok",
  "socketPath": "/tmp/claude-mcp-browser-bridge-user/23850.sock",
  "activeSessions": 0
}
```

### Current Bridge Limitations

The HTTP bridge successfully:

- Finds and connects to the Chrome MCP socket
- Uses correct binary protocol (4-byte length prefix)
- Proxies messages between HTTP and Unix socket

However, it currently **does not work** because:

- The Chrome native host uses a proprietary protocol
- Response messages don't include request IDs
- Standard MCP methods are not recognized

## Alternative Approaches

### 1. Reverse Engineer the Protocol

Capture and analyze actual communication between Claude Code CLI and the socket:

```bash
# Use strace/dtrace to monitor socket communication
# On macOS:
sudo dtrace -n 'syscall::write:entry /execname == "claude"/ { printf("%s", copyinstr(arg1)); }'
```

### 2. Use Claude Code as Proxy

Instead of bridging the socket directly, use Claude Code CLI as an intermediary:

```bash
# Host runs Claude Code with Chrome access
# Docker sends tasks via file/API to host Claude
# Host Claude executes browser tasks and writes results
```

### 3. Playwright MCP Alternative

Use Playwright MCP server instead of Chrome extension:

```bash
# Start Playwright MCP on host
npx @playwright/mcp@latest --host 0.0.0.0 --port 3000

# Docker connects to:
# http://host.docker.internal:3000/sse
```

This provides browser automation without needing the Chrome extension.

## Troubleshooting

### Socket Not Found

**Symptom**: `/tmp/claude-mcp-browser-bridge-$USER/` is empty

**Causes**:

1. Chrome is not running
2. Claude extension is not active
3. Extension hasn't connected to native host

**Fix**:

1. Open Chrome
2. Ensure Claude extension is installed and active
3. The socket is created when the extension first communicates with native host

### Socket Exists but Connection Refused

**Symptom**: Socket file exists but `nc -U` fails

**Causes**:

1. Native host process crashed
2. Socket is stale (process ended but socket file remains)

**Fix**:

```bash
# Check if native host is running
ps aux | grep chrome-native-host

# If not running, restart Chrome or the extension
# Socket will be recreated
```

### Protocol Mismatch Errors

**Symptom**: "Invalid message length" in native host logs

**Cause**: Sending newline-delimited JSON instead of length-prefixed binary

**Fix**: Use 4-byte little-endian length prefix before JSON payload

### Response ID Mismatch

**Symptom**: Responses received but can't match to requests

**Cause**: Chrome native host uses custom protocol without request IDs

**Current Status**: No known fix - this is how the protocol works

## Files Reference

| File                                                                                                                | Purpose                       |
| ------------------------------------------------------------------------------------------------------------------- | ----------------------------- |
| `~/.claude/chrome/chrome-native-host`                                                                               | Native messaging host wrapper |
| `~/Library/Application Support/Google/Chrome/NativeMessagingHosts/com.anthropic.claude_code_browser_extension.json` | Chrome native host manifest   |
| `~/Library/Logs/Claude/chrome-native-host.log`                                                                      | Native host logs              |
| `/tmp/claude-mcp-browser-bridge-$USER/*.sock`                                                                       | Unix socket for MCP           |
| `scripts/chrome-mcp-http-bridge.ts`                                                                                 | HTTP bridge implementation    |
| `scripts/start-chrome-mcp-bridge.sh`                                                                                | Bridge startup script         |

## Related Skills

- `docker-development` - Docker container setup
- `worktree-operations` - Working with git worktrees
- `multi-instance-development` - Running multiple instances
