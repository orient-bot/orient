# =============================================================================
# Orient - Staging Environment Override
# =============================================================================
# This file overrides the base v2 compose configuration for staging deployment.
#
# Usage on server:
#   docker compose -f docker-compose.v2.yml -f docker-compose.staging.yml up -d
#
# Features:
#   - Staging-specific ports (5097-5099 instead of 4097-4099)
#   - Separate database (whatsapp_bot_staging)
#   - Container names with -staging suffix
#   - Staging environment variables
#   - Pre-built images from ghcr.io with :staging tag
# =============================================================================

services:
  # ===========================================================================
  # NOTE: Nginx is NOT overridden here - staging uses production nginx
  # ===========================================================================
  # Production nginx (orienter-nginx) serves both production and staging via
  # dynamic DNS resolution. Staging containers must be on the production network.
  # See nginx-ssl.conf for routing configuration.
  # ===========================================================================

  # ===========================================================================
  # PostgreSQL - Staging Database
  # ===========================================================================
  postgres:
    container_name: orienter-postgres-staging
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      # Staging uses separate database
      - POSTGRES_DB=whatsapp_bot_staging
    # Staging database volume (replaces production volume)
    volumes: !override
      - postgres-data-staging:/var/lib/postgresql/data
    # Staging postgres port 5433
    ports: !override
      - '5433:5432'

  # ===========================================================================
  # MinIO - Staging Object Storage
  # ===========================================================================
  minio:
    container_name: orienter-minio-staging
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    # Staging minio ports (9010, 9011)
    ports: !override
      - '9010:9000'
      - '9011:9001'
    volumes: !override
      - minio-data-staging:/data

  # ===========================================================================
  # MinIO Setup - Staging Bucket
  # ===========================================================================
  minio-setup:
    container_name: orienter-minio-setup-staging
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      # Staging-specific bucket name
      - S3_BUCKET=${S3_BUCKET_STAGING:-orient-data-staging}

  # ===========================================================================
  # OpenCode Server + MCP Server (Staging)
  # ===========================================================================
  opencode:
    image: ghcr.io/orient-bot/orient/opencode:staging
    container_name: orienter-opencode-staging
    environment:
      - NODE_ENV=staging
      - TZ=Asia/Jerusalem
      - OPENCODE_PORT=5099
      - OPENCODE_HOSTNAME=0.0.0.0
      - DATA_DIR=/app/data
      - LOG_DIR=/app/logs
      # Staging database connection
      - DATABASE_URL=postgresql://orient:orient@orienter-postgres-staging:5432/whatsapp_bot_staging
      - S3_BUCKET=${S3_BUCKET_STAGING:-orient-data-staging}
      - S3_SYNC_INTERVAL=${S3_SYNC_INTERVAL:-60}
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - AWS_ENDPOINT_URL=http://orienter-minio-staging:9000
      - AWS_REGION=us-east-1
      - OAUTH_CALLBACK_PORT=${OAUTH_CALLBACK_PORT:-8765}
      - OAUTH_CALLBACK_HOST=${OAUTH_CALLBACK_HOST:-localhost}
      - OAUTH_CALLBACK_PROTOCOL=${OAUTH_CALLBACK_PROTOCOL:-http}
      # Staging OAuth callback URL
      - OAUTH_CALLBACK_URL=https://${ORIENT_STAGING_DOMAIN}/oauth/callback
    volumes: !override
      - opencode-data-staging:/app/data
      - opencode-storage-staging:/home/opencode/.local/share/opencode/storage
      - ../logs/staging:/app/logs
      - ../.mcp.config.local.json:/app/.mcp.config.json:ro
      - ../credentials:/app/credentials:ro
      - ../data/oauth-tokens-staging:/app/data/oauth-tokens
    ports: !override
      - '5099:5099'
      - '8766:8765'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5099/global/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================================================
  # WhatsApp Bot (Staging)
  # ===========================================================================
  bot-whatsapp:
    image: ghcr.io/orient-bot/orient/whatsapp-bot:staging
    container_name: orienter-bot-whatsapp-staging
    environment:
      - NODE_ENV=staging
      - TZ=Asia/Jerusalem
      # Staging database connection
      - DATABASE_URL=postgresql://orient:orient@orienter-postgres-staging:5432/whatsapp_bot_staging
      - OPENCODE_SERVER_URL=http://orienter-opencode-staging:5099
      - OPENCODE_URL=http://orienter-opencode-staging:5099
      - OPENCODE_ENABLED=true
      - S3_BUCKET=${S3_BUCKET_STAGING:-orienter-data-staging}
      - S3_SYNC_INTERVAL=${S3_SYNC_INTERVAL:-60}
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - AWS_ENDPOINT_URL=http://orienter-minio-staging:9000
      - AWS_REGION=us-east-1
      # Staging WhatsApp Cloud API settings (optional)
      - WHATSAPP_CLOUD_API_ENABLED=${WHATSAPP_CLOUD_API_ENABLED_STAGING:-false}
      - WHATSAPP_CLOUD_API_PHONE_NUMBER_ID=${WHATSAPP_CLOUD_API_PHONE_NUMBER_ID_STAGING:-}
      - WHATSAPP_CLOUD_API_ACCESS_TOKEN=${WHATSAPP_CLOUD_API_ACCESS_TOKEN_STAGING:-}
      - WHATSAPP_CLOUD_API_BUSINESS_ACCOUNT_ID=${WHATSAPP_CLOUD_API_BUSINESS_ACCOUNT_ID_STAGING:-}
      - WHATSAPP_CLOUD_API_WEBHOOK_VERIFY_TOKEN=${WHATSAPP_CLOUD_API_WEBHOOK_VERIFY_TOKEN_STAGING:-}
      - WHATSAPP_CLOUD_API_APP_SECRET=${WHATSAPP_CLOUD_API_APP_SECRET_STAGING:-}
      - WEBHOOK_FORWARD_SECRET=${WEBHOOK_FORWARD_SECRET_STAGING:-}
      # Staging OAuth callback URL
      - OAUTH_CALLBACK_URL=https://${ORIENT_STAGING_DOMAIN}/oauth/callback
      # Staging Google OAuth callback URL
      - GOOGLE_OAUTH_CALLBACK_URL=https://${ORIENT_STAGING_DOMAIN}/oauth/google/callback
    volumes: !override
      - ../data/staging:/app/data
      - ../.mcp.config.local.json:/app/.mcp.config.json:ro
      - ../logs/staging:/app/logs
      - ../credentials:/app/credentials:ro
    ports: !override
      - '5097:4097'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4097/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # ===========================================================================
  # Slack Bot (Staging - Optional)
  # ===========================================================================
  bot-slack:
    image: ghcr.io/orient-bot/orient/slack-bot:staging
    container_name: orienter-bot-slack-staging
    environment:
      - NODE_ENV=staging
      - TZ=Asia/Jerusalem
      - DATABASE_URL=postgresql://orient:orient@orienter-postgres-staging:5432/whatsapp_bot_staging
      - OPENCODE_SERVER_URL=http://orienter-opencode-staging:5099
      - OPENCODE_URL=http://orienter-opencode-staging:5099
      - OPENCODE_ENABLED=true
      # Staging Slack credentials (from .env.staging)
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN_STAGING}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET_STAGING}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN_STAGING}
      - SLACK_STANDUP_CHANNEL=${SLACK_STANDUP_CHANNEL_STAGING:-#standup-staging}
    volumes: !override
      - ../logs/staging:/app/logs
      - ../.mcp.config.local.json:/app/.mcp.config.json:ro
      - ../credentials:/app/credentials:ro

  # ===========================================================================
  # API Gateway (Staging - Optional)
  # ===========================================================================
  api-gateway:
    image: ghcr.io/orient-bot/orient/api-gateway:staging
    container_name: orienter-api-gateway-staging
    environment:
      - NODE_ENV=staging
      - TZ=Asia/Jerusalem
      - DATABASE_URL=postgresql://orient:orient@orienter-postgres-staging:5432/whatsapp_bot_staging
      - API_GATEWAY_PORT=4100
    volumes: !override
      - ../logs/staging:/app/logs
      - ../.mcp.config.local.json:/app/.mcp.config.json:ro
    ports: !override
      - '5100:4100'

  # ===========================================================================
  # Dashboard - Staging
  # ===========================================================================
  dashboard:
    image: ghcr.io/orient-bot/orient/dashboard:staging
    container_name: orienter-dashboard-staging
    environment:
      - NODE_ENV=staging
      - TZ=Asia/Jerusalem
      - DASHBOARD_PORT=4098
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@orienter-postgres-staging:5432/whatsapp_bot_staging
      - DASHBOARD_JWT_SECRET=${DASHBOARD_JWT_SECRET_STAGING}
      # SSH key path for production monitoring (mounted from ~/.ssh)
      - SSH_KEY_PATH=/app/.ssh/id_rsa
    volumes: !override
      - ../logs/staging:/app/logs
      # Mount SSH key for production server monitoring (from docker/.ssh directory)
      - ./.ssh:/app/.ssh:ro
    ports: !override
      - '5098:4098'
    # Override healthcheck with longer start_period for first deployment
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4098/health']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ===========================================================================
  # S3 Sync Service (Staging - Optional)
  # ===========================================================================
  s3-sync:
    container_name: orienter-s3-sync-staging
    environment:
      - S3_BUCKET=${S3_BUCKET_STAGING:-orienter-data-staging}
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - AWS_ENDPOINT_URL=http://orienter-minio-staging:9000
      - AWS_REGION=us-east-1
      - DATA_DIR=/app/data
      - LOG_DIR=/app/logs
      - S3_SYNC_INTERVAL=${S3_SYNC_INTERVAL:-60}
    volumes: !override
      - opencode-data-staging:/app/data
      - ../logs/staging:/app/logs
      - ./s3-sync.sh:/usr/local/bin/s3-sync.sh:ro

# =============================================================================
# Volumes (Staging-specific)
# =============================================================================
volumes:
  postgres-data-staging:
    driver: local
  minio-data-staging:
    driver: local
  opencode-data-staging:
    driver: local
  opencode-storage-staging:
    driver: local

# =============================================================================
# Networks - Join production network for nginx routing
# =============================================================================
# Staging containers must be on the same network as production nginx.
# Using external: true connects to the existing production network instead of
# creating a new staging_orienter-network.
networks:
  orienter-network:
    external: true
    name: docker_orienter-network
