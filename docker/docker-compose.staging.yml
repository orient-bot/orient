# =============================================================================
# Orient v0.2.0 - Staging Environment Override
# =============================================================================
# This file overrides the base v2 compose configuration for staging deployment.
#
# Usage on server:
#   docker compose -p staging -f docker-compose.v2.yml -f docker-compose.staging.yml \
#     up -d --no-deps minio opencode dashboard
#   docker network connect staging_orienter-network orienter-nginx
#
# IMPORTANT: Always use `-p staging` project flag to avoid overwriting production.
# After starting, connect production nginx to the staging network so it can
# route to staging containers (the last command above).
#
# v0.2.0 changes:
#   - PostgreSQL removed (now uses SQLite file-based database)
#   - WhatsApp integrated into Dashboard (no separate bot-whatsapp)
#   - Image registry: ghcr.io/orient-core/orient
#
# Features:
#   - Staging-specific ports (5098-5099 instead of 4098-4099)
#   - Separate SQLite database (in ~/orient/data/staging/)
#   - Container names with -staging suffix
#   - Pre-built images from ghcr.io with :staging tag
#   - Isolated network to avoid DNS collision with production
# =============================================================================

services:
  # ===========================================================================
  # NOTE: Nginx is NOT included here - staging uses production nginx.
  # After starting staging, connect nginx to the staging network:
  #   docker network connect staging_orienter-network orienter-nginx
  # ===========================================================================

  # ===========================================================================
  # MinIO - Staging Object Storage
  # ===========================================================================
  minio:
    container_name: orienter-minio-staging
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    # Staging minio ports (9010, 9011)
    ports: !override
      - '9010:9000'
      - '9011:9001'
    volumes: !override
      - minio-data-staging:/data

  # ===========================================================================
  # MinIO Setup - Staging Bucket
  # ===========================================================================
  minio-setup:
    container_name: orienter-minio-setup-staging
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      # Staging-specific bucket name
      - S3_BUCKET=${S3_BUCKET_STAGING:-orient-data-staging}

  # ===========================================================================
  # OpenCode Server + MCP Server (Staging)
  # ===========================================================================
  opencode:
    image: ghcr.io/orient-core/orient/opencode:staging
    container_name: orienter-opencode-staging
    environment:
      - NODE_ENV=staging
      - TZ=Asia/Jerusalem
      - OPENCODE_PORT=5099
      - OPENCODE_HOSTNAME=0.0.0.0
      - DATA_DIR=/app/data
      - LOG_DIR=/app/logs
      # SQLite database (file-based)
      - DATABASE_TYPE=sqlite
      - SQLITE_DATABASE=/app/data/orient.db
      - S3_BUCKET=${S3_BUCKET_STAGING:-orient-data-staging}
      - S3_SYNC_INTERVAL=${S3_SYNC_INTERVAL:-60}
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - AWS_ENDPOINT_URL=http://orienter-minio-staging:9000
      - AWS_REGION=us-east-1
      - OAUTH_CALLBACK_PORT=${OAUTH_CALLBACK_PORT:-8765}
      - OAUTH_CALLBACK_HOST=${OAUTH_CALLBACK_HOST:-localhost}
      - OAUTH_CALLBACK_PROTOCOL=${OAUTH_CALLBACK_PROTOCOL:-http}
      # Staging OAuth callback URL
      - OAUTH_CALLBACK_URL=https://${ORIENT_STAGING_DOMAIN}/oauth/callback
      - ORIENT_MASTER_KEY=${ORIENT_MASTER_KEY}
    volumes: !override
      - opencode-data-staging:/app/data
      - opencode-storage-staging:/home/opencode/.local/share/opencode/storage
      - ../logs/staging:/app/logs
      - ../.mcp.config.local.json:/app/.mcp.config.json:ro
      - ../credentials:/app/credentials:ro
      - ../data/oauth-tokens-staging:/app/data/oauth-tokens
    ports: !override
      - '5099:5099'
      - '8766:8765'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5099/global/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================================================
  # Slack Bot (Staging - Optional)
  # ===========================================================================
  bot-slack:
    image: ghcr.io/orient-core/orient/slack-bot:staging
    container_name: orienter-bot-slack-staging
    environment:
      - NODE_ENV=staging
      - TZ=Asia/Jerusalem
      # SQLite database (file-based)
      - DATABASE_TYPE=sqlite
      - SQLITE_DATABASE=/app/data/orient.db
      - OPENCODE_SERVER_URL=http://orienter-opencode-staging:5099
      - OPENCODE_URL=http://orienter-opencode-staging:5099
      - OPENCODE_ENABLED=true
      # Staging Slack credentials (from .env.staging)
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN_STAGING}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET_STAGING}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN_STAGING}
      - SLACK_STANDUP_CHANNEL=${SLACK_STANDUP_CHANNEL_STAGING:-#standup-staging}
      - ORIENT_MASTER_KEY=${ORIENT_MASTER_KEY}
    volumes: !override
      - opencode-data-staging:/app/data
      - ../logs/staging:/app/logs
      - ../.mcp.config.local.json:/app/.mcp.config.json:ro
      - ../credentials:/app/credentials:ro

  # ===========================================================================
  # API Gateway (Staging - Optional)
  # ===========================================================================
  api-gateway:
    image: ghcr.io/orient-core/orient/api-gateway:staging
    container_name: orienter-api-gateway-staging
    environment:
      - NODE_ENV=staging
      - TZ=Asia/Jerusalem
      # SQLite database (file-based)
      - DATABASE_TYPE=sqlite
      - SQLITE_DATABASE=/app/data/orient.db
      - API_GATEWAY_PORT=4100
    volumes: !override
      - opencode-data-staging:/app/data
      - ../logs/staging:/app/logs
      - ../.mcp.config.local.json:/app/.mcp.config.json:ro
    ports: !override
      - '5100:4100'

  # ===========================================================================
  # Dashboard - Unified server (Dashboard + WhatsApp) - Staging
  # ===========================================================================
  dashboard:
    image: ghcr.io/orient-core/orient/dashboard:staging
    container_name: orienter-dashboard-staging
    environment:
      - NODE_ENV=staging
      - TZ=Asia/Jerusalem
      - DASHBOARD_PORT=4098
      # SQLite database (file-based)
      - DATABASE_TYPE=sqlite
      - SQLITE_DATABASE=/app/data/orient.db
      - DASHBOARD_JWT_SECRET=${DASHBOARD_JWT_SECRET_STAGING}
      - ORIENT_MASTER_KEY=${ORIENT_MASTER_KEY}
      # SSH key path for production monitoring (mounted from ~/.ssh)
      - SSH_KEY_PATH=/app/.ssh/id_rsa
      # WhatsApp integration (unified server mode)
      - WHATSAPP_ENABLED=true
      - OPENCODE_URL=http://orienter-opencode-staging:5099
      - SESSION_PATH=/app/data/whatsapp-auth
      # Staging domain for OAuth auto-detection
      - ORIENT_STAGING_DOMAIN=${ORIENT_STAGING_DOMAIN}
      # Staging Google OAuth callback URL
      - GOOGLE_OAUTH_CALLBACK_URL=https://${ORIENT_STAGING_DOMAIN}/api/auth/google/callback
    volumes: !override
      - ../logs/staging:/app/logs
      # Mount SSH key for production server monitoring (from docker/.ssh directory)
      - ./.ssh:/app/.ssh:ro
      # WhatsApp session data and SQLite database
      - ../data/staging:/app/data
    ports: !override
      - '5098:4098'
    stdin_open: true
    tty: true
    # Override healthcheck with longer start_period for first deployment
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4098/health']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ===========================================================================
  # S3 Sync Service (Staging - Optional)
  # ===========================================================================
  s3-sync:
    container_name: orienter-s3-sync-staging
    environment:
      - S3_BUCKET=${S3_BUCKET_STAGING:-orienter-data-staging}
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - AWS_ENDPOINT_URL=http://orienter-minio-staging:9000
      - AWS_REGION=us-east-1
      - DATA_DIR=/app/data
      - LOG_DIR=/app/logs
      - S3_SYNC_INTERVAL=${S3_SYNC_INTERVAL:-60}
    volumes: !override
      - opencode-data-staging:/app/data
      - ../logs/staging:/app/logs
      - ./s3-sync.sh:/usr/local/bin/s3-sync.sh:ro

# =============================================================================
# Volumes (Staging-specific)
# =============================================================================
volumes:
  minio-data-staging:
    driver: local
  opencode-data-staging:
    driver: local
  opencode-storage-staging:
    driver: local

# =============================================================================
# Networks - Isolated staging network
# =============================================================================
# Staging uses its OWN network (not the production network) to prevent DNS
# alias collisions. Docker Compose always registers the service name (e.g.
# "dashboard") as a DNS alias. If staging joins the production network,
# both production and staging register "dashboard", causing nginx to route
# production traffic to staging containers.
#
# After starting staging, connect production nginx to this network:
#   docker network connect staging_orienter-network orienter-nginx
# =============================================================================
networks:
  orienter-network:
    driver: bridge
