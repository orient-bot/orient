# =============================================================================
# Orient - Nginx Staging Environment Configuration (HTTPS)
# =============================================================================
# Routes:
#   staging.example.com/*  -> Staging services (ports 5097-5099)
#   */health             -> Nginx health check
#
# Mode: HTTPS for staging environment
# =============================================================================

upstream opencode_staging_upstream {
    server opencode:5099;
}

upstream dashboard_staging_upstream {
    server dashboard:4098;
}

upstream qr_staging_upstream {
    server bot-whatsapp:4097;
}

# OAuth callback server for Atlassian MCP authentication (staging)
upstream oauth_callback_staging_upstream {
    server opencode:8765;
}

# =============================================================================
# HTTP Server - Redirect to HTTPS (except health check)
# =============================================================================
server {
    listen 80;
    server_name staging.example.com;

    # Health check endpoint (needed for Docker healthcheck over HTTP)
    location /health {
        access_log off;
        return 200 'OK - Staging';
        add_header Content-Type text/plain;
    }

    # Redirect all other HTTP traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# Fallback for IP-based access on staging ports (no redirect)
server {
    listen 80 default_server;
    server_name _;

    location /health {
        access_log off;
        return 200 'OK - Staging';
        add_header Content-Type text/plain;
    }

    location / {
        return 301 https://staging.example.com$request_uri;
    }
}

# =============================================================================
# HTTPS Server - staging.example.com (All Services)
# =============================================================================
server {
    listen 443 ssl;
    http2 on;
    server_name staging.example.com;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/staging.example.com/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/staging.example.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # Increase buffer sizes for proxied responses
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Common proxy settings
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Timeouts for long-running connections
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # -------------------------------------------------------------------------
    # Health check endpoint
    # -------------------------------------------------------------------------
    location /health {
        access_log off;
        return 200 'OK - Staging';
        add_header Content-Type text/plain;
    }

    # -------------------------------------------------------------------------
    # OAuth Callback for Atlassian MCP Authentication (Staging)
    # Production callback URL: https://staging.example.com/oauth/callback
    # -------------------------------------------------------------------------
    location /oauth/callback {
        proxy_pass http://oauth_callback_staging_upstream/oauth/callback;

        # Standard timeout - OAuth callbacks are quick
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # Google OAuth Callback (Staging)
    # Production callback URL: https://staging.example.com/oauth/google/callback
    # Must be registered in Google Cloud Console â†’ Authorized redirect URIs
    # -------------------------------------------------------------------------
    location /oauth/google/callback {
        proxy_pass http://dashboard_staging_upstream/oauth/google/callback;

        # Standard timeout - OAuth callbacks are quick
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp Cloud API Webhook (for Meta Business API - Staging)
    # Production callback URL: https://staging.example.com/webhooks/whatsapp
    # -------------------------------------------------------------------------
    location /webhooks/whatsapp {
        proxy_pass http://qr_staging_upstream/webhooks/whatsapp;

        # Standard timeout - webhook callbacks are quick
        proxy_read_timeout 30s;

        # Don't buffer webhook payloads
        proxy_buffering off;
    }

    # -------------------------------------------------------------------------
    # Webhook Forwarding API (for local dev testing)
    # -------------------------------------------------------------------------
    location /api/webhook-forward/ {
        proxy_pass http://qr_staging_upstream/api/webhook-forward/;

        # Standard timeout
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp QR Code / API (Staging)
    # -------------------------------------------------------------------------
    location /qr {
        proxy_pass http://qr_staging_upstream;

        # Keep connection alive for QR code updates
        proxy_read_timeout 120s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp Pairing Code API (Staging)
    # -------------------------------------------------------------------------
    location /pairing-code {
        proxy_pass http://qr_staging_upstream/pairing-code;
        proxy_read_timeout 60s;
    }

    # -------------------------------------------------------------------------
    # OpenCode API - Staging
    # -------------------------------------------------------------------------
    location /opencode/ {
        proxy_pass http://opencode_staging_upstream/;

        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode global API endpoints (staging)
    location /global/ {
        proxy_pass http://opencode_staging_upstream/global/;

        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode session endpoint (staging)
    location /session {
        proxy_pass http://opencode_staging_upstream/session;

        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode message endpoint (staging)
    location /message {
        proxy_pass http://opencode_staging_upstream/message;

        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode SSE events (staging)
    location /event {
        proxy_pass http://opencode_staging_upstream/event;

        # Keep connection alive for SSE events
        proxy_read_timeout 86400s;
        proxy_buffering off;
    }

    # -------------------------------------------------------------------------
    # Dashboard assets - staging
    # -------------------------------------------------------------------------
    location /dashboard/assets/ {
        proxy_pass http://dashboard_staging_upstream/assets/;
    }

    # -------------------------------------------------------------------------
    # Dashboard API - staging
    # -------------------------------------------------------------------------
    location /dashboard/api/ {
        proxy_pass http://dashboard_staging_upstream/api/;
    }

    # -------------------------------------------------------------------------
    # Legacy: Redirect /dashboard page to root (but not assets)
    # -------------------------------------------------------------------------
    location = /dashboard/ {
        return 301 https://staging.example.com/;
    }
    location = /dashboard {
        return 301 https://staging.example.com/;
    }

    # -------------------------------------------------------------------------
    # Admin Homepage (static files) - staging
    # -------------------------------------------------------------------------
    location /admin/ {
        alias /usr/share/nginx/html/;
        index index.html;
        try_files $uri $uri/ /admin/index.html;
    }

    # -------------------------------------------------------------------------
    # Default: Dashboard at root (staging)
    # -------------------------------------------------------------------------
    location / {
        proxy_pass http://dashboard_staging_upstream/;
    }
}

# =============================================================================
# code-staging.example.com - OpenCode Subdomain
# =============================================================================

# HTTP Server - Redirect code-staging.example.com to HTTPS
server {
    listen 80;
    server_name code-staging.example.com;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 'OK - OpenCode Staging';
        add_header Content-Type text/plain;
    }

    # Redirect all other HTTP traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS Server - code-staging.example.com (OpenCode Only)
server {
    listen 443 ssl;
    http2 on;
    server_name code-staging.example.com;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/code-staging.example.com/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/code-staging.example.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # Common proxy settings
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    location /health {
        access_log off;
        return 200 'OK - OpenCode Staging';
        add_header Content-Type text/plain;
    }

    # All routes go to OpenCode
    location / {
        proxy_pass http://opencode_staging_upstream;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
}
