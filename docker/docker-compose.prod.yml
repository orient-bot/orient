# =============================================================================
# Orient - Production Image Override
# =============================================================================
# This file overrides the build directives with pre-built images from ghcr.io.
#
# Usage on server (with v2 compose):
#   docker compose -f docker-compose.v2.yml -f docker-compose.prod.yml up -d
#
# Note: When 'image' is specified alongside 'build' in merged compose files,
# Docker Compose will use the image if it exists, otherwise build it.
# Since we're pulling images before 'up', the pre-built images are used.
#
# Registry: ghcr.io/orient-core/orient (personal fork for deployment)
# Container prefix: orienter-* (distinguishes from local dev containers)
# =============================================================================

services:
  # ===========================================================================
  # OpenCode Server - Use pre-built image from ghcr.io
  # ===========================================================================
  opencode:
    image: ghcr.io/orient-core/orient/opencode:latest
    container_name: orienter-opencode
    environment:
      # OAuth callback URL for Atlassian MCP (REQUIRED for production)
      # This URL must be registered with Atlassian at https://developer.atlassian.com
      - OAUTH_CALLBACK_URL=${OAUTH_CALLBACK_URL}

  # ===========================================================================
  # Slack Bot (optional profile) - Use pre-built image from ghcr.io
  # V2 service name: bot-slack (was: slack-bot)
  # ===========================================================================
  bot-slack:
    image: ghcr.io/orient-core/orient/slack-bot:latest
    container_name: orienter-bot-slack

  # ===========================================================================
  # Dashboard - Unified server (Dashboard + WhatsApp)
  # Use pre-built image from ghcr.io
  # ===========================================================================
  dashboard:
    image: ghcr.io/orient-core/orient/dashboard:latest
    container_name: orienter-dashboard
    environment:
      # Google OAuth callback URL (REQUIRED for production)
      # This URL must be registered in Google Cloud Console â†’ Authorized redirect URIs
      - GOOGLE_OAUTH_CALLBACK_URL=${GOOGLE_OAUTH_CALLBACK_URL}

  # ===========================================================================
  # Postgres - Production container name
  # ===========================================================================
  postgres:
    container_name: orienter-postgres

  # ===========================================================================
  # Nginx - Add staging SSL certificates for proxying staging traffic
  # ===========================================================================
  nginx:
    container_name: orienter-nginx
    # Extend base volumes to include staging SSL certificates
    volumes:
      - ./nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      - ./admin:/usr/share/nginx/html:ro
      # Production SSL certificates
      - ../certbot/conf/live/${ORIENT_APP_DOMAIN}/fullchain.pem:/etc/nginx/ssl/${ORIENT_APP_DOMAIN}/fullchain.pem:ro
      - ../certbot/conf/live/${ORIENT_APP_DOMAIN}/privkey.pem:/etc/nginx/ssl/${ORIENT_APP_DOMAIN}/privkey.pem:ro
      - ../certbot/conf/live/${ORIENT_CODE_DOMAIN}/fullchain.pem:/etc/nginx/ssl/${ORIENT_CODE_DOMAIN}/fullchain.pem:ro
      - ../certbot/conf/live/${ORIENT_CODE_DOMAIN}/privkey.pem:/etc/nginx/ssl/${ORIENT_CODE_DOMAIN}/privkey.pem:ro
      # Staging SSL certificates (for proxying staging traffic on port 443)
      - ../certbot/conf/live/${ORIENT_STAGING_DOMAIN}/fullchain.pem:/etc/nginx/ssl/${ORIENT_STAGING_DOMAIN}/fullchain.pem:ro
      - ../certbot/conf/live/${ORIENT_STAGING_DOMAIN}/privkey.pem:/etc/nginx/ssl/${ORIENT_STAGING_DOMAIN}/privkey.pem:ro
      - ../certbot/conf/live/${ORIENT_CODE_STAGING_DOMAIN}/fullchain.pem:/etc/nginx/ssl/${ORIENT_CODE_STAGING_DOMAIN}/fullchain.pem:ro
      - ../certbot/conf/live/${ORIENT_CODE_STAGING_DOMAIN}/privkey.pem:/etc/nginx/ssl/${ORIENT_CODE_STAGING_DOMAIN}/privkey.pem:ro
      - ../certbot/conf/archive:/etc/letsencrypt/archive:ro
