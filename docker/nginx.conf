# =============================================================================
# Orient - Nginx Reverse Proxy Configuration
# =============================================================================
# Routes:
#   /opencode/*   -> OpenCode Server (port 4099) [AUTH PROTECTED]
#   /dashboard/*  -> Dashboard (port 4098) - Also serves WhatsApp QR/API
#   /qr/*         -> Dashboard (port 4098) - WhatsApp pairing endpoints
#   /health       -> Nginx health check
#
# Mode: HTTP-only for local development
# For production with HTTPS, use nginx-ssl.conf
#
# Note: Dashboard runs unified server (Dashboard + WhatsApp) on single port
# =============================================================================

upstream opencode_upstream {
    server opencode:4099;
}

upstream dashboard_upstream {
    server dashboard:4098;
}

# OAuth callback server for Atlassian MCP authentication
upstream oauth_callback_upstream {
    server opencode:8765;
}

# =============================================================================
# HTTP Server - Main Configuration (Local Development)
# =============================================================================
server {
    listen 80 default_server;
    server_name _;

    # Increase buffer sizes for proxied responses
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Common proxy settings
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Timeouts for long-running connections
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # -------------------------------------------------------------------------
    # Health check endpoint
    # -------------------------------------------------------------------------
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # -------------------------------------------------------------------------
    # OAuth Callback for Atlassian MCP Authentication
    # Proxies OAuth callbacks from Atlassian to the OpenCode container
    # Local Docker callback URL: http://localhost/oauth/callback (port 80)
    # -------------------------------------------------------------------------
    location /oauth/callback {
        proxy_pass http://oauth_callback_upstream/oauth/callback;
        
        # Standard timeout - OAuth callbacks are quick
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # Google OAuth Callback
    # Proxies Google OAuth callbacks to the Dashboard server (whatsapp-bot)
    # Local Docker callback URL: http://localhost/oauth/google/callback
    # -------------------------------------------------------------------------
    location /oauth/google/callback {
        proxy_pass http://dashboard_upstream/oauth/google/callback;
        
        # Standard timeout - OAuth callbacks are quick
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # Authentication validation (internal location for auth_request)
    # -------------------------------------------------------------------------
    location = /_auth {
        internal;
        proxy_pass http://dashboard_upstream/api/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Host $host;
        # Pass cookies for token validation
        proxy_set_header Cookie $http_cookie;
    }

    # Custom error page for 401 - redirect to dashboard login
    error_page 401 = @login_redirect;
    location @login_redirect {
        return 302 /dashboard/?redirect=$scheme://$host$request_uri;
    }

    # -------------------------------------------------------------------------
    # OpenCode Server (protected by auth)
    # -------------------------------------------------------------------------
    location /opencode/ {
        auth_request /_auth;
        
        proxy_pass http://opencode_upstream/;
        
        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # -------------------------------------------------------------------------
    # OpenCode Static Assets (protected by auth)
    # OpenCode serves assets with absolute paths (/assets/, /favicon.*, etc.)
    # These need to be proxied to OpenCode when accessed from /opencode/
    # -------------------------------------------------------------------------
    location /assets/ {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/assets/;
    }

    location /favicon.ico {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/favicon.ico;
    }

    location /favicon.svg {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/favicon.svg;
    }

    location /favicon-96x96.png {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/favicon-96x96.png;
    }

    location /apple-touch-icon.png {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/apple-touch-icon.png;
    }

    location /site.webmanifest {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/site.webmanifest;
    }

    location /social-share.png {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/social-share.png;
    }

    # OpenCode global API endpoints (protected by auth)
    location /global/ {
        auth_request /_auth;
        
        proxy_pass http://opencode_upstream/global/;
        
        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode API endpoints (protected by auth)
    location /path {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/path;
    }

    location /project {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/project;
    }

    location /provider {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/provider;
    }

    location /session {
        auth_request /_auth;
        
        proxy_pass http://opencode_upstream/session;
        
        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    location /message {
        auth_request /_auth;
        
        proxy_pass http://opencode_upstream/message;
        
        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    location /event {
        auth_request /_auth;
        
        proxy_pass http://opencode_upstream/event;
        
        # Keep connection alive for SSE events
        proxy_read_timeout 86400s;
        proxy_buffering off;
    }

    location /file {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/file;
    }

    location /search {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/search;
    }

    location /lsp {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/lsp;
    }

    location /mcp {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/mcp;
    }

    location /agent {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/agent;
    }

    location /init {
        auth_request /_auth;
        proxy_pass http://opencode_upstream/init;
    }

    # -------------------------------------------------------------------------
    # WhatsApp Dashboard
    # -------------------------------------------------------------------------
    location /dashboard/ {
        proxy_pass http://dashboard_upstream/;
    }

    # -------------------------------------------------------------------------
    # Dashboard API (for Mini-Apps and other dashboard features)
    # -------------------------------------------------------------------------
    location /api/ {
        proxy_pass http://dashboard_upstream/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # -------------------------------------------------------------------------
    # Mini-Apps static files
    # -------------------------------------------------------------------------
    location /apps/ {
        proxy_pass http://dashboard_upstream/apps/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # -------------------------------------------------------------------------
    # WhatsApp QR Code / API (served by unified dashboard server)
    # Note: No trailing slashes to preserve the /qr prefix in the request path
    # -------------------------------------------------------------------------
    location /qr {
        proxy_pass http://dashboard_upstream;

        # Keep connection alive for QR code updates
        proxy_read_timeout 120s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp Pairing Code API (served by unified dashboard server)
    # -------------------------------------------------------------------------
    location /pairing-code {
        proxy_pass http://dashboard_upstream/pairing-code;
        proxy_read_timeout 60s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp Health Check (served by unified dashboard server)
    # -------------------------------------------------------------------------
    location /whatsapp/health {
        proxy_pass http://dashboard_upstream/whatsapp/health;
    }

    # -------------------------------------------------------------------------
    # Admin Homepage
    # -------------------------------------------------------------------------
    location /admin/ {
        alias /usr/share/nginx/html/;
        index index.html;
        try_files $uri $uri/ /admin/index.html;
    }

    # -------------------------------------------------------------------------
    # Default: OpenCode at root (protected by auth)
    # -------------------------------------------------------------------------
    location / {
        auth_request /_auth;
        
        proxy_pass http://opencode_upstream/;
        
        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
}
