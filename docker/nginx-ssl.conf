# =============================================================================
# Orient - Nginx Reverse Proxy Configuration (HTTPS/Production)
# =============================================================================
# Routes:
#   code.orient.bot/*  -> OpenCode Server (port 4099) [AUTH PROTECTED]
#   app.orient.bot/     -> WhatsApp Dashboard (port 4098)
#   app.orient.bot/qr   -> WhatsApp QR/API (port 4097)
#   staging.orient.bot/ -> Staging Dashboard (dynamic resolution)
#   code-staging.orient.bot/ -> Staging OpenCode (dynamic resolution)
#   */health          -> Nginx health check
#
# Mode: HTTPS for production + staging
# =============================================================================

# Docker's embedded DNS resolver - enables dynamic upstream resolution
# This allows nginx to start even if staging containers don't exist
resolver 127.0.0.11 valid=30s ipv6=off;

upstream opencode_upstream {
    server opencode:4099;
}

upstream dashboard_upstream {
    server dashboard:4098;
}

upstream qr_upstream {
    server bot-whatsapp:4097;
}

# OAuth callback server for Atlassian MCP authentication
upstream oauth_callback_upstream {
    server opencode:8765;
}

# =============================================================================
# Staging - Dynamic Resolution
# =============================================================================
# Staging containers use dynamic DNS resolution (see resolver directive above).
# This allows nginx to start even if staging containers don't exist.
# When staging is down, requests return 502 Bad Gateway (expected behavior).
#
# Staging containers must be on the same Docker network as production:
#   docker compose -p staging -f docker-compose.v2.yml -f docker-compose.staging.yml up -d
#
# Container names used (resolved at request time):
#   - orienter-opencode-staging:5099
#   - orienter-dashboard-staging:4098
#   - orienter-bot-whatsapp-staging:4097

# =============================================================================
# HTTP Server - Redirect to HTTPS (except health check)
# =============================================================================
server {
    listen 80;
    server_name app.orient.bot code.orient.bot staging.orient.bot code-staging.orient.bot;

    # Health check endpoint (needed for Docker healthcheck over HTTP)
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Redirect all other HTTP traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# Fallback for IP-based access (no redirect)
server {
    listen 80 default_server;
    server_name _;

    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    location / {
        return 301 https://app.orient.bot$request_uri;
    }
}

# =============================================================================
# HTTPS Server - code.orient.bot (OpenCode) - AUTH PROTECTED
# =============================================================================
server {
    listen 443 ssl;
    http2 on;
    server_name code.orient.bot;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/code.orient.bot/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/code.orient.bot/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # Increase buffer sizes for proxied responses
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Common proxy settings
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Timeouts for long-running connections
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # -------------------------------------------------------------------------
    # Authentication validation (internal location for auth_request)
    # -------------------------------------------------------------------------
    location = /_auth {
        internal;
        proxy_pass http://dashboard_upstream/api/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Host $host;
        # Pass cookies for token validation
        proxy_set_header Cookie $http_cookie;
    }

    # Custom error page for 401 - redirect to dashboard login
    error_page 401 = @login_redirect;
    location @login_redirect {
        return 302 https://app.orient.bot/?redirect=$scheme://$host$request_uri;
    }

    # -------------------------------------------------------------------------
    # Health check endpoint (no auth required)
    # -------------------------------------------------------------------------
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # -------------------------------------------------------------------------
    # OpenCode - Everything goes to OpenCode (protected by auth)
    # -------------------------------------------------------------------------
    location / {
        auth_request /_auth;
        auth_request_set $auth_status $upstream_status;
        
        proxy_pass http://opencode_upstream/;
        
        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode global API endpoints (protected by auth)
    location /global/ {
        auth_request /_auth;
        
        proxy_pass http://opencode_upstream/global/;
        
        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode session endpoint (protected by auth)
    location /session {
        auth_request /_auth;
        
        proxy_pass http://opencode_upstream/session;
        
        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode message endpoint (protected by auth)
    location /message {
        auth_request /_auth;
        
        proxy_pass http://opencode_upstream/message;
        
        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode SSE events (protected by auth)
    location /event {
        auth_request /_auth;
        
        proxy_pass http://opencode_upstream/event;
        
        # Keep connection alive for SSE events
        proxy_read_timeout 86400s;
        proxy_buffering off;
    }
}

# =============================================================================
# HTTPS Server - app.orient.bot (Dashboard + QR)
# =============================================================================
server {
    listen 443 ssl;
    http2 on;
    server_name app.orient.bot;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/app.orient.bot/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/app.orient.bot/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # Increase buffer sizes for proxied responses
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Common proxy settings
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Timeouts for long-running connections
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # -------------------------------------------------------------------------
    # Health check endpoint
    # -------------------------------------------------------------------------
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # -------------------------------------------------------------------------
    # OAuth Callback for Atlassian MCP Authentication
    # Proxies OAuth callbacks from Atlassian to the OpenCode container
    # Production callback URL: https://app.orient.bot/oauth/callback
    # -------------------------------------------------------------------------
    location /oauth/callback {
        proxy_pass http://oauth_callback_upstream/oauth/callback;
        
        # Standard timeout - OAuth callbacks are quick
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # Google OAuth Callback
    # Proxies Google OAuth callbacks to the Dashboard server (whatsapp-bot)
    # Production callback URL: https://app.orient.bot/oauth/google/callback
    # Must be registered in Google Cloud Console → Authorized redirect URIs
    # -------------------------------------------------------------------------
    location /oauth/google/callback {
        proxy_pass http://dashboard_upstream/oauth/google/callback;
        
        # Standard timeout - OAuth callbacks are quick
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp Cloud API Webhook (for Meta Business API)
    # Production callback URL: https://app.orient.bot/webhooks/whatsapp
    # Register this URL in Meta Developer Console → WhatsApp → Configuration
    # -------------------------------------------------------------------------
    location /webhooks/whatsapp {
        proxy_pass http://qr_upstream/webhooks/whatsapp;
        
        # Standard timeout - webhook callbacks are quick
        proxy_read_timeout 30s;
        
        # Don't buffer webhook payloads
        proxy_buffering off;
    }

    # -------------------------------------------------------------------------
    # Webhook Forwarding API (for local dev testing)
    # Allows local dev environments to register for webhook forwarding
    # -------------------------------------------------------------------------
    location /api/webhook-forward/ {
        proxy_pass http://qr_upstream/api/webhook-forward/;
        
        # Standard timeout
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp QR Code / API
    # Note: No trailing slashes to preserve the /qr prefix in the request path
    # -------------------------------------------------------------------------
    location /qr {
        proxy_pass http://qr_upstream;
        
        # Keep connection alive for QR code updates
        proxy_read_timeout 120s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp Pairing Code API
    # -------------------------------------------------------------------------
    location /pairing-code {
        proxy_pass http://qr_upstream/pairing-code;
        proxy_read_timeout 60s;
    }

    # -------------------------------------------------------------------------
    # Legacy: Redirect /opencode to code.orient.bot
    # -------------------------------------------------------------------------
    location /opencode {
        return 301 https://code.orient.bot$request_uri;
    }

    # -------------------------------------------------------------------------
    # Dashboard assets - strip /dashboard prefix when proxying to server
    # (server serves assets at /assets/, not /dashboard/assets/)
    # -------------------------------------------------------------------------
    location /dashboard/assets/ {
        proxy_pass http://dashboard_upstream/assets/;
    }

    # -------------------------------------------------------------------------
    # Dashboard mascot images - strip /dashboard prefix when proxying
    # (server serves mascot at /mascot/, not /dashboard/mascot/)
    # -------------------------------------------------------------------------
    location /dashboard/mascot/ {
        proxy_pass http://dashboard_upstream/mascot/;
    }

    # -------------------------------------------------------------------------
    # Dashboard API - proxy /dashboard/api/ to /api/ on dashboard server
    # (Frontend uses BASE_URL=/dashboard/ so API calls go to /dashboard/api/)
    # -------------------------------------------------------------------------
    location /dashboard/api/ {
        proxy_pass http://dashboard_upstream/api/;
    }

    # -------------------------------------------------------------------------
    # Legacy: Redirect /dashboard page to root (but not assets)
    # -------------------------------------------------------------------------
    location = /dashboard/ {
        return 301 https://app.orient.bot/;
    }
    location = /dashboard {
        return 301 https://app.orient.bot/;
    }

    # -------------------------------------------------------------------------
    # Admin Homepage (static files)
    # -------------------------------------------------------------------------
    location /admin/ {
        alias /usr/share/nginx/html/;
        index index.html;
        try_files $uri $uri/ /admin/index.html;
    }

    # -------------------------------------------------------------------------
    # Default: Dashboard at root
    # -------------------------------------------------------------------------
    location / {
        proxy_pass http://dashboard_upstream/;
    }
}

# =============================================================================
# HTTPS Server - staging.orient.bot (Staging Dashboard)
# =============================================================================
# Uses dynamic DNS resolution - returns 502 if staging containers are down.
server {
    listen 443 ssl;
    http2 on;
    server_name staging.orient.bot;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/staging.orient.bot/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/staging.orient.bot/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # Increase buffer sizes for proxied responses
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Common proxy settings
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Timeouts for long-running connections
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Dynamic upstream variables (resolved at request time via Docker DNS)
    set $staging_dashboard orienter-dashboard-staging:4098;
    set $staging_qr orienter-bot-whatsapp-staging:4097;

    # -------------------------------------------------------------------------
    # Health check endpoint (always returns OK for nginx health)
    # -------------------------------------------------------------------------
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # -------------------------------------------------------------------------
    # OAuth Callback for Atlassian MCP Authentication (Staging)
    # -------------------------------------------------------------------------
    location /oauth/callback {
        set $staging_oauth orienter-opencode-staging:8765;
        proxy_pass http://$staging_oauth/oauth/callback;
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # Google OAuth Callback (Staging)
    # -------------------------------------------------------------------------
    location /oauth/google/callback {
        proxy_pass http://$staging_dashboard/oauth/google/callback;
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp Cloud API Webhook (Staging)
    # -------------------------------------------------------------------------
    location /webhooks/whatsapp {
        proxy_pass http://$staging_qr/webhooks/whatsapp;
        proxy_read_timeout 30s;
        proxy_buffering off;
    }

    # -------------------------------------------------------------------------
    # Webhook Forwarding API (Staging)
    # -------------------------------------------------------------------------
    location /api/webhook-forward/ {
        proxy_pass http://$staging_qr/api/webhook-forward/;
        proxy_read_timeout 30s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp QR Code / API (Staging)
    # -------------------------------------------------------------------------
    location /qr {
        proxy_pass http://$staging_qr;
        proxy_read_timeout 120s;
    }

    # -------------------------------------------------------------------------
    # WhatsApp Pairing Code API (Staging)
    # -------------------------------------------------------------------------
    location /pairing-code {
        proxy_pass http://$staging_qr/pairing-code;
        proxy_read_timeout 60s;
    }

    # -------------------------------------------------------------------------
    # Dashboard assets (Staging)
    # -------------------------------------------------------------------------
    location /dashboard/assets/ {
        proxy_pass http://$staging_dashboard/assets/;
    }

    # -------------------------------------------------------------------------
    # Dashboard mascot images (Staging)
    # -------------------------------------------------------------------------
    location /dashboard/mascot/ {
        proxy_pass http://$staging_dashboard/mascot/;
    }

    # -------------------------------------------------------------------------
    # Dashboard API (Staging)
    # -------------------------------------------------------------------------
    location /dashboard/api/ {
        proxy_pass http://$staging_dashboard/api/;
    }

    # -------------------------------------------------------------------------
    # Legacy dashboard redirects (Staging)
    # -------------------------------------------------------------------------
    location = /dashboard/ {
        return 301 https://staging.orient.bot/;
    }
    location = /dashboard {
        return 301 https://staging.orient.bot/;
    }

    # -------------------------------------------------------------------------
    # Default: Dashboard at root (Staging)
    # -------------------------------------------------------------------------
    location / {
        proxy_pass http://$staging_dashboard/;
    }
}

# =============================================================================
# HTTPS Server - code-staging.orient.bot (Staging OpenCode) - AUTH PROTECTED
# =============================================================================
# Uses dynamic DNS resolution - returns 502 if staging containers are down.
server {
    listen 443 ssl;
    http2 on;
    server_name code-staging.orient.bot;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/code-staging.orient.bot/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/code-staging.orient.bot/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # Increase buffer sizes for proxied responses
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Common proxy settings
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Timeouts for long-running connections
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Dynamic upstream variables (resolved at request time via Docker DNS)
    set $staging_opencode orienter-opencode-staging:5099;
    set $staging_dashboard_auth orienter-dashboard-staging:4098;

    # -------------------------------------------------------------------------
    # Authentication validation (internal location for auth_request)
    # Uses staging dashboard for auth validation
    # -------------------------------------------------------------------------
    location = /_auth {
        internal;
        proxy_pass http://$staging_dashboard_auth/api/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Host $host;
        # Pass cookies for token validation
        proxy_set_header Cookie $http_cookie;
    }

    # Custom error page for 401 - redirect to staging dashboard login
    error_page 401 = @login_redirect;
    location @login_redirect {
        return 302 https://staging.orient.bot/?redirect=$scheme://$host$request_uri;
    }

    # -------------------------------------------------------------------------
    # Health check endpoint (no auth required)
    # -------------------------------------------------------------------------
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # -------------------------------------------------------------------------
    # OpenCode - Everything goes to OpenCode (protected by auth)
    # -------------------------------------------------------------------------
    location / {
        auth_request /_auth;
        auth_request_set $auth_status $upstream_status;

        proxy_pass http://$staging_opencode/;

        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode global API endpoints (protected by auth)
    location /global/ {
        auth_request /_auth;

        proxy_pass http://$staging_opencode/global/;

        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode session endpoint (protected by auth)
    location /session {
        auth_request /_auth;

        proxy_pass http://$staging_opencode/session;

        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode message endpoint (protected by auth)
    location /message {
        auth_request /_auth;

        proxy_pass http://$staging_opencode/message;

        # Longer timeouts for AI processing
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # OpenCode SSE events (protected by auth)
    location /event {
        auth_request /_auth;

        proxy_pass http://$staging_opencode/event;

        # Keep connection alive for SSE events
        proxy_read_timeout 86400s;
        proxy_buffering off;
    }
}
