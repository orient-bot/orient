# =============================================================================
# Orient - Docker Compose Configuration (LEGACY)
# =============================================================================
#
# DEPRECATION NOTICE:
# This file uses monolithic Dockerfiles that build the entire codebase.
# For improved build times and smaller images, use docker-compose.v2.yml
# which uses per-package Dockerfiles.
#
# To migrate:
#   docker compose -f docker-compose.v2.yml -f docker-compose.local.yml up -d
#
# See docs/docker-migration-plan.md for details.
#
# =============================================================================
# This setup includes:
# - Nginx (reverse proxy / ingress)
# - PostgreSQL (database for messages and permissions)
# - MinIO (S3-compatible storage for media files)
# - OpenCode Server (with MCP server sidecar)
# - WhatsApp Bot (connects to OpenCode for AI processing)
# - S3 Sync service (for data persistence)
# - Optional: Slack PM Bot
#
# Quick Start:
#   docker compose up -d
#
# Access via Nginx (port 80):
#   /opencode/   -> OpenCode Server
#   /dashboard/  -> WhatsApp Dashboard
#   /qr/         -> WhatsApp QR Code / API
#
# For Oracle Cloud Free Tier (ARM64), ensure you build with:
#   docker compose build --platform linux/arm64
# =============================================================================

services:
  # ===========================================================================
  # Nginx - Reverse Proxy / Ingress
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: orienter-nginx
    restart: unless-stopped
    depends_on:
      opencode:
        condition: service_healthy
      whatsapp-bot:
        condition: service_healthy
    ports:
      - '80:80'
      - '443:443'
    volumes:
      # Use nginx-ssl.conf for production (HTTPS)
      # For local dev, use docker-compose.local.yml override which uses nginx.conf (HTTP)
      - ./nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      - ./admin:/usr/share/nginx/html:ro
      # SSL certificates from Let's Encrypt (managed by certbot)
      # SSL certificates (configure domains in env vars)
      - ../certbot/conf/live/${ORIENT_APP_DOMAIN}/fullchain.pem:/etc/nginx/ssl/${ORIENT_APP_DOMAIN}/fullchain.pem:ro
      - ../certbot/conf/live/${ORIENT_APP_DOMAIN}/privkey.pem:/etc/nginx/ssl/${ORIENT_APP_DOMAIN}/privkey.pem:ro
      - ../certbot/conf/live/${ORIENT_CODE_DOMAIN}/fullchain.pem:/etc/nginx/ssl/${ORIENT_CODE_DOMAIN}/fullchain.pem:ro
      - ../certbot/conf/live/${ORIENT_CODE_DOMAIN}/privkey.pem:/etc/nginx/ssl/${ORIENT_CODE_DOMAIN}/privkey.pem:ro
      - ../certbot/conf/archive:/etc/letsencrypt/archive:ro
    networks:
      - orienter-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: '5m'
        max-file: '2'
  # ===========================================================================
  # PostgreSQL - Database for messages and permissions
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: orienter-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-whatsapp_bot_0}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    networks:
      - orienter-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB:-whatsapp_bot_0}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: '5m'
        max-file: '2'
  # ===========================================================================
  # MinIO - S3-Compatible Object Storage (Local Development)
  # ===========================================================================
  minio:
    image: minio/minio:latest
    container_name: orienter-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    ports:
      - '9000:9000' # S3 API
      - '9001:9001' # MinIO Console
    volumes:
      - minio-data:/data
    networks:
      - orienter-network
    healthcheck:
      test: ['CMD', 'mc', 'ready', 'local']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: '5m'
        max-file: '2'

  # ===========================================================================
  # MinIO Setup - Creates bucket on startup
  # ===========================================================================
  minio-setup:
    image: minio/mc:latest
    container_name: orienter-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - S3_BUCKET=${S3_BUCKET:-orienter-data}
    entrypoint: >
      /bin/sh -c "
        echo 'Waiting for MinIO to be ready...';
        sleep 5;
        mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
        mc mb myminio/$${S3_BUCKET} --ignore-existing;
        mc anonymous set download myminio/$${S3_BUCKET};
        echo 'MinIO bucket $${S3_BUCKET} created successfully';
        exit 0;
      "
    networks:
      - orienter-network

  # ===========================================================================
  # OpenCode Server + MCP Server (Sidecar Pattern)
  # ===========================================================================
  opencode:
    build:
      context: ..
      dockerfile: docker/Dockerfile.opencode
    container_name: orienter-opencode
    restart: unless-stopped
    depends_on:
      minio:
        condition: service_healthy
        required: false
      minio-setup:
        condition: service_completed_successfully
        required: false
      postgres:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      - NODE_ENV=production
      - TZ=Asia/Jerusalem
      - OPENCODE_PORT=${OPENCODE_PORT:-4099}
      - OPENCODE_HOSTNAME=0.0.0.0
      - MCP_SERVER_PATH=/app/packages/mcp-servers/dist/coding-server.js
      - DATA_DIR=/app/data
      - LOG_DIR=/app/logs
      # PostgreSQL database connection (for MCP WhatsApp tools)
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-whatsapp_bot_0}
      # S3/MinIO configuration
      - S3_BUCKET=${S3_BUCKET:-orienter-data}
      - S3_SYNC_INTERVAL=${S3_SYNC_INTERVAL:-60}
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - AWS_ENDPOINT_URL=http://minio:9000
      - AWS_REGION=us-east-1
      # OAuth callback configuration for Atlassian MCP
      # Override these for production (e.g., OAUTH_CALLBACK_URL=https://app.example.com/oauth/callback)
      - OAUTH_CALLBACK_PORT=${OAUTH_CALLBACK_PORT:-8765}
      - OAUTH_CALLBACK_HOST=${OAUTH_CALLBACK_HOST:-localhost}
      - OAUTH_CALLBACK_PROTOCOL=${OAUTH_CALLBACK_PROTOCOL:-http}
      - OAUTH_CALLBACK_URL=${OAUTH_CALLBACK_URL:-}
      # LLM Provider keys are loaded from .env file via env_file directive
      # At least one of ANTHROPIC_API_KEY, OPENAI_API_KEY, or XAI_API_KEY is required
    volumes:
      # Persistent data directory
      - opencode-data:/app/data
      # OpenCode session storage (CRITICAL - sessions are stored here)
      - opencode-storage:/home/opencode/.local/share/opencode/storage
      # Logs
      - ../logs:/app/logs
      # Config file
      - ../.mcp.config.local.json:/app/.mcp.config.json:ro
      # Credentials for Google services
      - ../credentials:/app/credentials:ro
      # OAuth tokens for Atlassian MCP (persist across restarts)
      - ../data/oauth-tokens:/app/data/oauth-tokens
    ports:
      - '${OPENCODE_PORT:-4099}:${OPENCODE_PORT:-4099}'
      # OAuth callback server port for Atlassian MCP interactive authorization
      - '${OAUTH_CALLBACK_PORT:-8765}:${OAUTH_CALLBACK_PORT:-8765}'
    networks:
      - orienter-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:${OPENCODE_PORT:-4099}/global/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'

  # ===========================================================================
  # WhatsApp Bot
  # ===========================================================================
  whatsapp-bot:
    build:
      context: ..
      dockerfile: docker/Dockerfile.whatsapp
    container_name: orienter-whatsapp-bot
    restart: unless-stopped
    depends_on:
      opencode:
        condition: service_healthy
      minio:
        condition: service_healthy
        required: false
      postgres:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      - NODE_ENV=production
      - TZ=Asia/Jerusalem
      # PostgreSQL database connection
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-whatsapp_bot_0}
      # Connect to OpenCode container
      - OPENCODE_SERVER_URL=http://opencode:${OPENCODE_PORT:-4099}
      - OPENCODE_URL=http://opencode:${OPENCODE_PORT:-4099}
      - OPENCODE_ENABLED=true
      # S3/MinIO configuration
      - S3_BUCKET=${S3_BUCKET:-orienter-data}
      - S3_SYNC_INTERVAL=${S3_SYNC_INTERVAL:-60}
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - AWS_ENDPOINT_URL=http://minio:9000
      - AWS_REGION=us-east-1
      # WhatsApp Cloud API (Bot Mode) - for dual-mode communication
      # Configure these to enable proactive notifications via a dedicated bot number
      - WHATSAPP_CLOUD_API_ENABLED=${WHATSAPP_CLOUD_API_ENABLED:-false}
      - WHATSAPP_CLOUD_API_PHONE_NUMBER_ID=${WHATSAPP_CLOUD_API_PHONE_NUMBER_ID:-}
      - WHATSAPP_CLOUD_API_ACCESS_TOKEN=${WHATSAPP_CLOUD_API_ACCESS_TOKEN:-}
      - WHATSAPP_CLOUD_API_BUSINESS_ACCOUNT_ID=${WHATSAPP_CLOUD_API_BUSINESS_ACCOUNT_ID:-}
      - WHATSAPP_CLOUD_API_WEBHOOK_VERIFY_TOKEN=${WHATSAPP_CLOUD_API_WEBHOOK_VERIFY_TOKEN:-}
      - WHATSAPP_CLOUD_API_APP_SECRET=${WHATSAPP_CLOUD_API_APP_SECRET:-}
      # Webhook forwarding to local dev (for testing while production is running)
      # Set this to a shared secret (min 16 chars) to enable dev webhook forwarding
      - WEBHOOK_FORWARD_SECRET=${WEBHOOK_FORWARD_SECRET:-}
    volumes:
      # Mount LOCAL data directory directly (for session persistence)
      - ../data:/app/data
      # Mount config file
      - ../.mcp.config.local.json:/app/.mcp.config.json:ro
      # Mount logs
      - ../logs:/app/logs
      # Mount credentials for Google services
      - ../credentials:/app/credentials:ro
      # Mount mini-apps directory for serving built apps
      - ../apps:/app/apps:ro
    ports:
      - '4097:4097' # WhatsApp API/QR Web UI
      - '4098:4098' # Dashboard
    networks:
      - orienter-network
    # Interactive mode for QR code scanning on first run
    stdin_open: true
    tty: true
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4097/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s # Allow time for QR code scanning
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'

  # ===========================================================================
  # S3 Sync Service (for data persistence to MinIO/S3)
  # ===========================================================================
  s3-sync:
    image: amazon/aws-cli:latest
    container_name: orienter-s3-sync
    restart: unless-stopped
    profiles:
      - s3 # Only starts when using: docker compose --profile s3 up
    depends_on:
      minio:
        condition: service_healthy
    environment:
      - S3_BUCKET=${S3_BUCKET:-orienter-data}
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - AWS_ENDPOINT_URL=http://minio:9000
      - AWS_REGION=us-east-1
      - DATA_DIR=/app/data
      - LOG_DIR=/app/logs
      - S3_SYNC_INTERVAL=${S3_SYNC_INTERVAL:-60}
    volumes:
      - opencode-data:/app/data
      - whatsapp-data:/app/whatsapp-data
      - ../logs:/app/logs
      - ./s3-sync.sh:/usr/local/bin/s3-sync.sh:ro
    entrypoint: ['/bin/bash', '/usr/local/bin/s3-sync.sh', 'daemon']
    networks:
      - orienter-network
    logging:
      driver: json-file
      options:
        max-size: '5m'
        max-file: '2'

  # ===========================================================================
  # Slack Bot (Optional)
  # ===========================================================================
  # Start with: docker compose --profile slack up
  slack-bot:
    build:
      context: ..
      dockerfile: docker/Dockerfile.slack
    container_name: orienter-slack-bot
    restart: unless-stopped
    profiles:
      - slack # Only starts when using: docker compose --profile slack up
    depends_on:
      opencode:
        condition: service_healthy
      postgres:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      - NODE_ENV=production
      - TZ=Asia/Jerusalem
      # PostgreSQL database connection (same database, separate tables)
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-whatsapp_bot_0}
      # Connect to OpenCode container
      - OPENCODE_SERVER_URL=http://opencode:${OPENCODE_PORT:-4099}
      - OPENCODE_URL=http://opencode:${OPENCODE_PORT:-4099}
      - OPENCODE_ENABLED=true
      # Slack credentials (from .env)
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN}
      - SLACK_STANDUP_CHANNEL=${SLACK_STANDUP_CHANNEL:-#standup}
      # Health Monitor (auto-pairing notifications)
      - HEALTH_MONITOR_ENABLED=${HEALTH_MONITOR_ENABLED:-false}
      - HEALTH_MONITOR_SLACK_USER_ID=${HEALTH_MONITOR_SLACK_USER_ID}
      # WhatsApp admin phone for pairing code requests
      - WHATSAPP_ADMIN_PHONE=${WHATSAPP_ADMIN_PHONE}
      # GitHub for skill PRs
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPO=${GITHUB_REPO}
      - GITHUB_BASE_BRANCH=${GITHUB_BASE_BRANCH:-main}
      # Skill Admin Authorization
      - SKILL_ADMIN_PHONES=${SKILL_ADMIN_PHONES}
      - SKILL_ADMIN_SLACK_IDS=${SKILL_ADMIN_SLACK_IDS}
    volumes:
      - ../logs:/app/logs
      - ../.mcp.config.local.json:/app/.mcp.config.json:ro
      - ../credentials:/app/credentials:ro
    networks:
      - orienter-network
    healthcheck:
      test: ['CMD', 'node', '-e', "console.log('healthy')"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'

# =============================================================================
# Networks
# =============================================================================
networks:
  orienter-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres-data:
    driver: local
  minio-data:
    driver: local
  opencode-data:
    driver: local
  opencode-storage:
    driver: local
  whatsapp-data:
    driver: local
