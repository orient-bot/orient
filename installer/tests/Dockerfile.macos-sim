# =============================================================================
# Orient Installer Test Environment
# =============================================================================
# Docker image simulating a clean Linux environment for testing the
# Orient installer scripts.
#
# Based on node:20-slim (glibc-based, required for OpenCode binary)
# Includes: git, bash, curl, openssl (prerequisites)
# Does NOT include: pnpm (installer should handle this)
# =============================================================================

FROM node:20-slim

# Install required tools (simulating prerequisites)
# Note: Using glibc-based image (not Alpine) for OpenCode binary compatibility
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    git-lfs \
    bash \
    curl \
    openssl \
    jq \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user to simulate developer environment
# This is important because installers should work without root
RUN useradd -m -s /bin/bash developer && \
    chown -R developer:developer /home/developer

# pnpm is NOT pre-installed - the installer should detect this and install it
# This simulates a fresh developer machine

# Set up the developer user environment
USER developer
WORKDIR /home/developer

# Set bash as the default shell
SHELL ["/bin/bash", "-c"]

# Create standard directories the installer might use
RUN mkdir -p /home/developer/.local/bin

# Add .local/bin to PATH for user-installed binaries
ENV PATH="/home/developer/.local/bin:${PATH}"

# Verify the environment is clean
RUN echo "=== Environment Check ===" && \
    echo "Node: $(node --version)" && \
    echo "npm: $(npm --version)" && \
    echo "Git: $(git --version)" && \
    echo "Bash: $(bash --version | head -1)" && \
    echo "pnpm: $(pnpm --version 2>/dev/null || echo 'NOT INSTALLED (expected)')" && \
    echo "User: $(whoami)" && \
    echo "Home: $HOME" && \
    echo "========================="

# Default command shows environment info
CMD ["bash", "-c", "echo 'Orient Test Environment Ready' && bash"]
