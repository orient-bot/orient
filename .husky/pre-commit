#!/bin/sh

# =============================================================================
# IDENTITY CHECK - Block commits from tom-genoox
# =============================================================================
AUTHOR_EMAIL=$(git config user.email)
AUTHOR_NAME=$(git config user.name)

if [ "$AUTHOR_EMAIL" = "tom@genoox.com" ]; then
    echo "ERROR: Commit blocked!"
    echo "You are trying to commit with email: $AUTHOR_EMAIL"
    echo "This identity is blocked in this repository."
    echo ""
    echo "Please set your git identity to your personal account:"
    echo "  git config user.email 'your-personal@email.com'"
    echo "  git config user.name 'Your Name'"
    exit 1
fi

case "$AUTHOR_NAME" in
  *tom-genoox*)
    echo "ERROR: Commit blocked!"
    echo "You are trying to commit with author name: $AUTHOR_NAME"
    echo "This identity is blocked in this repository."
    echo ""
    echo "Please set your git identity to your personal account:"
    echo "  git config user.email 'your-personal@email.com'"
    echo "  git config user.name 'Your Name'"
    exit 1
    ;;
esac

# =============================================================================
# Pre-commit Hook for Orient Monorepo
# =============================================================================
# This hook runs quality checks before allowing commits.
#
# BYPASS OPTIONS (for temp commits when working with multiple agents):
#   1. Use --no-verify flag: git commit --no-verify -m "message"
#   2. Set env var: TEMP_COMMIT=1 git commit -m "[temp] message"
#   3. Set env var: SKIP_HOOKS=1 git commit -m "message"
#   4. Use npm script: npm run commit:temp -- "message"
#
# The hook will also be skipped if the commit message starts with:
#   - [temp]
#   - [wip]
#   - [skip-ci]
#   - [no-verify]
# =============================================================================

# Check for bypass environment variables
if [ "$TEMP_COMMIT" = "1" ] || [ "$SKIP_HOOKS" = "1" ]; then
  echo "Pre-commit hooks bypassed via environment variable"
  exit 0
fi

# Get the commit message if available (for amend or with -m flag)
COMMIT_MSG=""
if [ -f ".git/COMMIT_EDITMSG" ]; then
  COMMIT_MSG=$(head -n 1 .git/COMMIT_EDITMSG)
elif [ -f ".git/MERGE_MSG" ]; then
  COMMIT_MSG=$(head -n 1 .git/MERGE_MSG)
fi

# Check for bypass patterns in commit message
case "$COMMIT_MSG" in
  "[temp]"*|"[wip]"*|"[skip-ci]"*|"[no-verify]"*)
    echo "Pre-commit hooks bypassed via commit message prefix"
    exit 0
    ;;
esac

echo "Running pre-commit checks..."
echo ""

# Track if any check fails
FAILED=0

# =============================================================================
# Step 1: Run lint-staged (lint and format staged files)
# =============================================================================
echo "Step 1/3: Running lint-staged..."
if ! npx lint-staged; then
  echo "lint-staged failed"
  FAILED=1
fi

# =============================================================================
# Step 2: TypeScript type checking
# =============================================================================
if [ "$FAILED" = "0" ]; then
  echo ""
  echo "Step 2/3: Running typecheck on affected packages..."
  if ! pnpm turbo run typecheck --filter='...[HEAD]' 2>/dev/null; then
    # Fallback to root typecheck if turbo fails
    if ! npm run typecheck; then
      echo "Typecheck failed"
      FAILED=1
    fi
  fi
fi

# =============================================================================
# Step 3: Run quick unit tests (optional, can be skipped with SKIP_TESTS=1)
# =============================================================================
if [ "$FAILED" = "0" ] && [ "$SKIP_TESTS" != "1" ]; then
  echo ""
  echo "Step 3/3: Running quick tests..."

  # Get list of staged TypeScript files
  STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | grep -v '\.test\.' | grep -v '\.spec\.')

  if [ -n "$STAGED_FILES" ]; then
    # Run tests related to staged files (vitest has built-in related file detection)
    if ! npx vitest run --changed HEAD --passWithNoTests 2>/dev/null; then
      echo "Tests failed"
      FAILED=1
    fi
  else
    echo "No TypeScript files staged, skipping tests"
  fi
else
  echo ""
  echo "Step 3/3: Tests skipped (SKIP_TESTS=1 or previous step failed)"
fi

# =============================================================================
# Summary
# =============================================================================
echo ""
if [ "$FAILED" = "1" ]; then
  echo "Pre-commit checks failed. Fix the issues above or use one of these bypass options:"
  echo "  - git commit --no-verify -m 'message'"
  echo "  - TEMP_COMMIT=1 git commit -m '[temp] message'"
  echo "  - npm run commit:temp -- 'message'"
  exit 1
fi

echo "All pre-commit checks passed!"
exit 0
