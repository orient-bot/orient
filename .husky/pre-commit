#!/bin/sh

# =============================================================================
# IDENTITY CHECK - Block commits from tom-genoox
# =============================================================================
AUTHOR_EMAIL=$(git config user.email)
AUTHOR_NAME=$(git config user.name)

if [ "$AUTHOR_EMAIL" = "tom@genoox.com" ]; then
    echo "ERROR: Commit blocked!"
    echo "You are trying to commit with email: $AUTHOR_EMAIL"
    echo "This identity is blocked in this repository."
    echo ""
    echo "Please set your git identity to your personal account:"
    echo "  git config user.email 'your-personal@email.com'"
    echo "  git config user.name 'Your Name'"
    exit 1
fi

case "$AUTHOR_NAME" in
  *tom-genoox*)
    echo "ERROR: Commit blocked!"
    echo "You are trying to commit with author name: $AUTHOR_NAME"
    echo "This identity is blocked in this repository."
    echo ""
    echo "Please set your git identity to your personal account:"
    echo "  git config user.email 'your-personal@email.com'"
    echo "  git config user.name 'Your Name'"
    exit 1
    ;;
esac

# =============================================================================
# Pre-commit Hook for Orient Monorepo
# =============================================================================
# This hook runs quality checks before allowing commits.
#
# BYPASS OPTIONS (for temp commits when working with multiple agents):
#   1. Use --no-verify flag: git commit --no-verify -m "message"
#   2. Set env var: TEMP_COMMIT=1 git commit -m "[temp] message"
#   3. Set env var: SKIP_HOOKS=1 git commit -m "message"
#   4. Use npm script: npm run commit:temp -- "message"
#
# The hook will also be skipped if the commit message starts with:
#   - [temp]
#   - [wip]
#   - [skip-ci]
#   - [no-verify]
# =============================================================================

# Check for bypass environment variables
if [ "$TEMP_COMMIT" = "1" ] || [ "$SKIP_HOOKS" = "1" ]; then
  echo "Pre-commit hooks bypassed via environment variable"
  exit 0
fi

# Get the commit message if available (for amend or with -m flag)
COMMIT_MSG=""
if [ -f ".git/COMMIT_EDITMSG" ]; then
  COMMIT_MSG=$(head -n 1 .git/COMMIT_EDITMSG)
elif [ -f ".git/MERGE_MSG" ]; then
  COMMIT_MSG=$(head -n 1 .git/MERGE_MSG)
fi

# Check for bypass patterns in commit message
case "$COMMIT_MSG" in
  "[temp]"*|"[wip]"*|"[skip-ci]"*|"[no-verify]"*)
    echo "Pre-commit hooks bypassed via commit message prefix"
    exit 0
    ;;
esac

# =============================================================================
# FAST Pre-commit: Prettier only (ESLint/typecheck/tests run in CI)
# =============================================================================
# ESLint with type-aware rules is slow (~2min). Skip it here, run in CI.
# Your editor has ESLint for real-time feedback.
# =============================================================================

echo "Running pre-commit checks..."

# Get staged files
STAGED_TS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)
STAGED_OTHER=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(json|md|yml|yaml)$' || true)

# Format staged TypeScript files
if [ -n "$STAGED_TS" ]; then
  echo "Formatting TypeScript files..."
  echo "$STAGED_TS" | xargs pnpm exec prettier --write --log-level warn
  echo "$STAGED_TS" | xargs git add
fi

# Format staged config/doc files
if [ -n "$STAGED_OTHER" ]; then
  echo "Formatting config/doc files..."
  echo "$STAGED_OTHER" | xargs pnpm exec prettier --write --log-level warn
  echo "$STAGED_OTHER" | xargs git add
fi

echo "Pre-commit checks passed! (ESLint/typecheck/tests run in CI)"
exit 0
